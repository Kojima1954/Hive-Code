# System Architecture

## Overview Diagram

```
┌─────────────────────────────────────────────────────────────────────┐
│                     CONVERSATIONAL SWARM NETWORK                      │
└─────────────────────────────────────────────────────────────────────┘

┌────────────────────────────────────────────────────────────────────┐
│                         PRESENTATION LAYER                          │
├────────────────────────────────────────────────────────────────────┤
│  ┌──────────────────┐          ┌──────────────────┐               │
│  │  Web UI (HTML)   │◄────────►│   WebSocket      │               │
│  │  - Chat Interface│          │   - Real-time    │               │
│  │  - WhatsApp Style│          │   - Auto-reconnect│              │
│  └──────────────────┘          └──────────────────┘               │
└────────────────────────────────────────────────────────────────────┘
                                    ▲
                                    │ HTTP/WS
                                    ▼
┌────────────────────────────────────────────────────────────────────┐
│                         APPLICATION LAYER                           │
├────────────────────────────────────────────────────────────────────┤
│  ┌──────────────────────────────────────────────────────────────┐ │
│  │                    FastAPI Application                        │ │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐             │ │
│  │  │ REST API   │  │ WebSocket  │  │ Connection │             │ │
│  │  │ Endpoints  │  │ Handler    │  │ Manager    │             │ │
│  │  └────────────┘  └────────────┘  └────────────┘             │ │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐             │ │
│  │  │ JWT Auth   │  │ CORS       │  │ Rate Limit │             │ │
│  │  │ Middleware │  │ Middleware │  │ Middleware │             │ │
│  │  └────────────┘  └────────────┘  └────────────┘             │ │
│  └──────────────────────────────────────────────────────────────┘ │
└────────────────────────────────────────────────────────────────────┘
                                    ▲
                                    │
                                    ▼
┌────────────────────────────────────────────────────────────────────┐
│                           CORE LAYER                                │
├────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐ │
│  │                      NODE MANAGEMENT                          │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │ │
│  │  │ HumanAINode │  │ Participant │  │   Message   │          │ │
│  │  │   Manager   │◄─┤   Manager   │◄─┤   Router    │          │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘          │ │
│  │         │                  │                  │               │ │
│  │         ▼                  ▼                  ▼               │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │ │
│  │  │   Ollama    │  │   Human     │  │  Message    │          │ │
│  │  │   Agents    │  │ Participants│  │  Encryption │          │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘          │ │
│  └──────────────────────────────────────────────────────────────┘ │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐ │
│  │                     MEMORY SYSTEM                             │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │ │
│  │  │  DiffMem    │  │  Embedding  │  │  Clustering │          │ │
│  │  │  Manager    │◄─┤  Generator  │◄─┤   (DBSCAN)  │          │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘          │ │
│  │         │                  │                  │               │ │
│  │         ▼                  ▼                  ▼               │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │ │
│  │  │    Git      │  │ Sentence    │  │ Importance  │          │ │
│  │  │  Storage    │  │Transformers │  │   Scoring   │          │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘          │ │
│  └──────────────────────────────────────────────────────────────┘ │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐ │
│  │                    SECURITY LAYER                             │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │ │
│  │  │   Hybrid    │  │    Rate     │  │     TLS     │          │ │
│  │  │ Encryption  │  │  Limiting   │  │   Manager   │          │ │
│  │  │ RSA+AES-GCM │  │   (Redis)   │  │             │          │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘          │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │ │
│  │  │    DDoS     │  │     JWT     │  │   IP Ban    │          │ │
│  │  │ Protection  │  │ Verification│  │  Management │          │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘          │ │
│  └──────────────────────────────────────────────────────────────┘ │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐ │
│  │                   FEDERATION LAYER                            │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │ │
│  │  │ ActivityPub │  │  Blockchain │  │   Message   │          │ │
│  │  │  Connector  │◄─┤ Verification│◄─┤   Signing   │          │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘          │ │
│  │         │                  │                  │               │ │
│  │         ▼                  ▼                  ▼               │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │ │
│  │  │   Actor     │  │    Hash     │  │     RSA     │          │ │
│  │  │   Profile   │  │    Chain    │  │   Signing   │          │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘          │ │
│  └──────────────────────────────────────────────────────────────┘ │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐ │
│  │                   MONITORING LAYER                            │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │ │
│  │  │ Prometheus  │  │   Logging   │  │   Health    │          │ │
│  │  │   Metrics   │  │   (JSON)    │  │   Checks    │          │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘          │ │
│  │         │                  │                  │               │ │
│  │         ▼                  ▼                  ▼               │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │ │
│  │  │  Counters   │  │  Rotating   │  │   System    │          │ │
│  │  │ Histograms  │  │   Files     │  │   Metrics   │          │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘          │ │
│  └──────────────────────────────────────────────────────────────┘ │
└────────────────────────────────────────────────────────────────────┘
                                    ▲
                                    │
                                    ▼
┌────────────────────────────────────────────────────────────────────┐
│                      INFRASTRUCTURE LAYER                           │
├────────────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐            │
│  │    Redis     │  │    Ollama    │  │  Prometheus  │            │
│  │  Pub/Sub +   │  │   LLM API    │  │    Metrics   │            │
│  │   Storage    │  │  (llama2)    │  │   Collector  │            │
│  └──────────────┘  └──────────────┘  └──────────────┘            │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐            │
│  │   Grafana    │  │     Git      │  │   File       │            │
│  │ Dashboards   │  │  Repository  │  │   System     │            │
│  └──────────────┘  └──────────────┘  └──────────────┘            │
└────────────────────────────────────────────────────────────────────┘
                                    ▲
                                    │
                                    ▼
┌────────────────────────────────────────────────────────────────────┐
│                      DEPLOYMENT LAYER                               │
├────────────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐            │
│  │    Docker    │  │    Docker    │  │  Kubernetes  │            │
│  │  Container   │  │   Compose    │  │  Deployment  │            │
│  └──────────────┘  └──────────────┘  └──────────────┘            │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐            │
│  │     HPA      │  │ StatefulSet  │  │  Persistent  │            │
│  │ Auto-scaling │  │   (Redis)    │  │   Volumes    │            │
│  └──────────────┘  └──────────────┘  └──────────────┘            │
└────────────────────────────────────────────────────────────────────┘
```

## Data Flow

### 1. Message Flow

```
User Input → WebSocket → FastAPI → HumanAINode → Message Processing
                                          ↓
                                    Encryption
                                          ↓
                                    Redis Pub/Sub
                                          ↓
                                    ┌─────┴─────┐
                                    ▼           ▼
                              Memory Storage  AI Agents
                                    │           │
                                    │           ▼
                                    │     Ollama LLM
                                    │           │
                                    │           ▼
                                    │     AI Response
                                    │           │
                                    └───────────┤
                                                ▼
                                        Broadcast to Users
```

### 2. Memory Flow

```
Message → DiffMemManager → Embedding Generation → Vector Storage
                                    │
                                    ▼
                              Git Commit
                                    │
                                    ▼
                              Clustering (DBSCAN)
                                    │
                                    ▼
                              Importance Scoring
                                    │
                                    ▼
                              Consolidation (periodic)
                                    │
                                    ▼
                              Similarity Search
```

### 3. Security Flow

```
Request → Rate Limiter → DDoS Check → JWT Verification
                              │
                              ▼
                        Allowed/Blocked
                              │
                              ▼
                        Message Encryption
                              │
                              ▼
                        TLS/SSL Transport
```

### 4. Federation Flow

```
Local Activity → ActivityPub Message → Signature (RSA)
                                            │
                                            ▼
                                      Blockchain Record
                                            │
                                            ▼
                                      HTTP POST to Inbox
                                            │
                                            ▼
                                      Remote Instance
```

## Component Interactions

### Real-time Communication

```
┌─────────┐     WebSocket      ┌──────────────┐
│ Browser │◄──────────────────►│  FastAPI     │
└─────────┘                     │  /ws/{user}  │
                                └──────┬───────┘
                                       │
                                       ▼
                                ┌──────────────┐
                                │ Connection   │
                                │ Manager      │
                                └──────┬───────┘
                                       │
                                       ▼
                                ┌──────────────┐     ┌──────────┐
                                │ Redis        │────►│ All      │
                                │ Pub/Sub      │     │ Clients  │
                                └──────────────┘     └──────────┘
```

### AI Agent Processing

```
┌─────────────┐     Process      ┌──────────────┐
│ Message     │────────────────►│ HumanAINode  │
└─────────────┘                  └──────┬───────┘
                                        │
                                        ▼
                                 ┌──────────────┐
                                 │ OllamaAgent  │
                                 └──────┬───────┘
                                        │
                                        ▼
                                 ┌──────────────┐
                                 │ Ollama API   │
                                 │ (llama2)     │
                                 └──────┬───────┘
                                        │
                                        ▼
                                 ┌──────────────┐
                                 │ AI Response  │
                                 └──────────────┘
```

## Technology Stack

```
┌─────────────────────────────────────────────────┐
│              Frontend                            │
│  • HTML5 / CSS3 / JavaScript                    │
│  • WebSocket API                                │
│  • Responsive Design                            │
└─────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────┐
│              Backend                             │
│  • Python 3.11+                                 │
│  • FastAPI (async framework)                    │
│  • Uvicorn (ASGI server)                        │
│  • Pydantic (data validation)                   │
└─────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────┐
│              AI/ML                               │
│  • Ollama (LLM inference)                       │
│  • sentence-transformers (embeddings)           │
│  • scikit-learn (clustering)                    │
│  • numpy (numerical operations)                 │
└─────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────┐
│              Storage                             │
│  • Redis (pub/sub + caching)                    │
│  • Git (version control)                        │
│  • File System (memory storage)                 │
└─────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────┐
│              Security                            │
│  • cryptography (RSA + AES-GCM)                 │
│  • PyJWT (JSON Web Tokens)                      │
│  • TLS/SSL certificates                         │
└─────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────┐
│              Monitoring                          │
│  • Prometheus (metrics)                         │
│  • Grafana (visualization)                      │
│  • psutil (system metrics)                      │
│  • Structured logging (JSON)                    │
└─────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────┐
│              Infrastructure                      │
│  • Docker (containerization)                    │
│  • Docker Compose (orchestration)               │
│  • Kubernetes (production deployment)           │
│  • HPA (auto-scaling)                           │
└─────────────────────────────────────────────────┘
```

## Scalability Architecture

```
┌────────────────────────────────────────────────────────┐
│                    Load Balancer                        │
└───────────────────┬────────────────────────────────────┘
                    │
        ┌───────────┼───────────┐
        ▼           ▼           ▼
    ┌──────┐    ┌──────┐    ┌──────┐
    │ Node │    │ Node │    │ Node │  ◄── Horizontal Scaling
    │  1   │    │  2   │    │  N   │
    └───┬──┘    └───┬──┘    └───┬──┘
        │           │           │
        └───────────┼───────────┘
                    ▼
            ┌──────────────┐
            │    Redis     │  ◄── Shared State
            │   Cluster    │
            └──────────────┘
                    │
                    ▼
            ┌──────────────┐
            │  Persistent  │  ◄── Shared Storage
            │   Storage    │
            └──────────────┘
```

## Security Layers

```
┌─────────────────────────────────────────┐
│         Network Layer (TLS/SSL)          │
├─────────────────────────────────────────┤
│      Application Layer (JWT Auth)        │
├─────────────────────────────────────────┤
│    Transport Layer (Rate Limiting)       │
├─────────────────────────────────────────┤
│     Data Layer (Hybrid Encryption)       │
├─────────────────────────────────────────┤
│   Storage Layer (Git + Compression)      │
└─────────────────────────────────────────┘
```
